{% extends "base.html" %}
{% block title %}Today's Timetable{% endblock %}

{% block content %}
<div class="space-y-10 animate-fade-down">

  <!-- Header -->
  <header class="text-center space-y-2">
    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white tracking-tight">
      📅 Classes for <span class="text-accent">{{ day }}</span>
    </h1>
    <p class="text-sm text-gray-500 dark:text-gray-400">Your daily timetable overview</p>
  </header>

  {% if classes %}
  <!-- Actions/Filters -->
  <div class="flex flex-wrap gap-3 justify-center items-center">
    <input id="searchToday" type="text" placeholder="🔍 Search today's classes"
           class="px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-secondary text-sm w-72 focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent transition">

    <select id="statusFilter" 
            class="px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-secondary text-sm focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent transition">
      <option value="">All Status</option>
      <option value="Ongoing">Ongoing</option>
      <option value="Upcoming">Upcoming</option>
      <option value="Completed">Completed</option>
    </select>

    <button onclick="window.location.href='{{ url_for('main.export_pdf') }}'"
            class="px-4 py-2 text-xs bg-red-100 text-red-800 rounded hover:bg-red-200 dark:bg-red-900 dark:text-red-100 dark:hover:bg-red-700 transition">📄 Export PDF</button>

    <button onclick="window.location.href='{{ url_for('main.export_csv') }}'"
            class="px-4 py-2 text-xs bg-green-100 text-green-800 rounded hover:bg-green-200 dark:bg-green-900 dark:text-green-100 dark:hover:bg-green-700 transition">📊 Export CSV</button>
  </div>

  <!-- Grid of classes -->
  <section id="todayGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 mt-4">
    {% for cls in classes %}
    <article class="relative flex flex-col rounded-xl shadow-md hover:shadow-xl hover:-translate-y-[3px] transition-all duration-300 overflow-hidden border border-border/50 dark:border-gray-700 animate-fade-down"
             style="animation-delay: {{ loop.index0 * 100 }}ms"
             data-status="{{ cls.status }}"
             data-search="{{ (cls.courseCode ~ ' ' ~ cls.courseName ~ ' ' ~ (cls.instructor or '') ~ ' ' ~ (cls.room if cls.room is string else cls.room|join(' '))) | lower }}">

      <!-- Colored type bar -->
      <div class="absolute left-0 top-0 h-full w-1.5
        {% if cls.type|lower == 'lab' %}bg-green-500
        {% elif cls.type|lower == 'lecture' %}bg-blue-500
        {% elif cls.type|lower == 'tutorial' %}bg-yellow-500
        {% else %}bg-gray-400{% endif %}">
      </div>

      <!-- Card content -->
      <div class="p-5 flex flex-col flex-grow">
        
        <!-- Status badge -->
        <div class="mb-2">
          {% if cls.status == 'Ongoing' %}
            <span class="px-3 py-1 text-xs rounded-full font-semibold bg-green-200 text-green-800 flex items-center gap-1">🟢 Ongoing</span>
          {% elif cls.status == 'Upcoming' %}
            <span class="px-3 py-1 text-xs rounded-full font-semibold bg-blue-200 text-blue-800 flex items-center gap-1">🔵 Upcoming</span>
          {% else %}
            <span class="px-3 py-1 text-xs rounded-full font-semibold bg-gray-300 text-gray-800 flex items-center gap-1">⚪ Completed</span>
          {% endif %}
        </div>

        <!-- Course Code & Name -->
        <div class="mb-3">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">{{ cls.courseCode }}</h2>
          <p class="text-sm text-gray-600 dark:text-gray-300">{{ cls.courseName }}</p>
          {% if cls.section %}
            <div class="mt-1 text-xs inline-block bg-accent/20 text-accent px-2 py-0.5 rounded">Sec {{ cls.section }}</div>
          {% endif %}
        </div>

        <!-- Time & Room -->
        <div class="text-sm space-y-1 flex-grow">
          <p>⏰ <span class="font-semibold">{{ cls.time }}</span></p>
          <p>🏫
            {% if cls.room is string %}
              {{ cls.room }}
            {% else %}
              {{ cls.room | join(', ') }}
            {% endif %}
          </p>
        </div>

        <!-- Instructor -->
        <p class="text-xs italic text-gray-500 dark:text-gray-400 mt-2">👨‍🏫 {{ cls.instructor or "TBA" }}</p>

        {% if cls.notes %}
          <p class="text-xs italic text-gray-500 dark:text-gray-400">🗒️ {{ cls.notes }}</p>
        {% endif %}

        <!-- Footer meta -->
        <div class="mt-4 flex items-center justify-between">
          <span class="px-2 py-0.5 text-xs font-semibold rounded
            {% if cls.type|lower == 'lab' %}bg-green-100 text-green-700
            {% elif cls.type|lower == 'lecture' %}bg-blue-100 text-blue-700
            {% elif cls.type|lower == 'tutorial' %}bg-yellow-100 text-yellow-700
            {% else %}bg-gray-200 text-gray-700{% endif %}">
            {{ cls.type or 'Other' }}
          </span>
        </div>
      </div>
    </article>
    {% endfor %}
  </section>

  {% else %}
  <!-- No classes -->
  <div class="text-center text-gray-500 dark:text-gray-400 mt-20 italic">
    <div class="text-6xl mb-4">🎉</div>
    <p>No classes today - Enjoy your day!</p>
  </div>
  {% endif %}
</div>

<!-- Live Filtering -->
<script>
document.getElementById('searchToday')?.addEventListener('input', filterToday);
document.getElementById('statusFilter')?.addEventListener('change', filterToday);

function filterToday() {
  const searchText = document.getElementById('searchToday').value.toLowerCase();
  const statusVal = document.getElementById('statusFilter').value;
  document.querySelectorAll('#todayGrid article').forEach(card => {
    const matchesSearch = card.dataset.search.includes(searchText);
    const matchesStatus = !statusVal || card.dataset.status === statusVal;
    card.style.display = matchesSearch && matchesStatus ? '' : 'none';
  });
}
</script>
{% endblock %}
